<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Variation Designs - Clean Up Old Data</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; }
        button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }
        button:hover { background: #c82333; }
        button.safe { background: #28a745; }
        button.safe:hover { background: #218838; }
        .log-entry {
            padding: 8px;
            margin: 4px 0;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            font-family: monospace;
            font-size: 13px;
        }
        .error { border-left-color: #dc3545; background: #fff5f5; }
        .success { border-left-color: #28a745; background: #f5fff5; }
        .warning { border-left-color: #ffc107; background: #fffdf5; }
        #output { max-height: 600px; overflow-y: auto; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Variation Designs Storage</h1>
        <p><strong>Problem:</strong> Old variation designs with color-based IDs are stored in localStorage and Redux, causing designs to sync between angles.</p>
        <p><strong>Solution:</strong> Clean up old data and keep only angle-based designs.</p>
        
        <div class="stats" id="stats"></div>
        
        <div style="margin: 20px 0;">
            <button onclick="analyzeCurrentState()">üìä Analyze Current State</button>
            <button class="safe" onclick="cleanupOldDesigns()">üßπ Clean Up Old Designs (Safe)</button>
            <button onclick="nukeEverything()">‚ò¢Ô∏è Nuclear Option - Clear ALL Design Data</button>
        </div>
        
        <div id="output" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        function updateStats(oldDesigns = 0, angleDesigns = 0, colorDesigns = 0) {
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${oldDesigns}</div>
                    <div class="stat-label">Old Designs in Redux</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${angleDesigns}</div>
                    <div class="stat-label">Angle-Based Designs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${colorDesigns}</div>
                    <div class="stat-label">Color-Based Designs</div>
                </div>
            `;
        }

        function analyzeCurrentState() {
            log('=== Analyzing Current State ===', 'info');
            
            // Check the variationDesigns key
            const variationDesignsData = localStorage.getItem('variationDesigns');
            if (variationDesignsData) {
                try {
                    const designs = JSON.parse(variationDesignsData);
                    log(`Found ${designs.length} designs in 'variationDesigns' key`, 'warning');
                    
                    let angleBasedCount = 0;
                    let colorBasedCount = 0;
                    
                    designs.forEach(design => {
                        if (design.variationId?.includes('_angle_')) {
                            angleBasedCount++;
                            log(`  ‚úÖ Angle-based: ${design.variationId}`, 'success');
                        } else {
                            colorBasedCount++;
                            log(`  ‚ùå Color-based: ${design.variationId}`, 'error');
                        }
                    });
                    
                    updateStats(designs.length, angleBasedCount, colorBasedCount);
                    
                    if (colorBasedCount > 0) {
                        log(`\n‚ö†Ô∏è Found ${colorBasedCount} old color-based designs that need cleanup!`, 'warning');
                    }
                } catch (e) {
                    log(`Error parsing variationDesigns: ${e.message}`, 'error');
                }
            } else {
                log('No variationDesigns key found in localStorage', 'success');
            }
            
            // Check Redux persist state
            const persistRoot = localStorage.getItem('persist:root');
            if (persistRoot) {
                try {
                    const parsed = JSON.parse(persistRoot);
                    if (parsed.design) {
                        const designState = JSON.parse(parsed.design);
                        const reduxDesigns = designState.variationDesigns || [];
                        log(`\nRedux has ${reduxDesigns.length} variation designs`, 'info');
                        
                        if (reduxDesigns.length > 20) {
                            log(`  ‚ö†Ô∏è That's too many! Likely includes old designs.`, 'warning');
                        }
                    }
                } catch (e) {
                    log(`Error parsing Redux state: ${e.message}`, 'error');
                }
            }
            
            // Check individual design_ keys
            const designKeys = Object.keys(localStorage).filter(key => key.startsWith('design_'));
            log(`\nFound ${designKeys.length} individual design_ keys`, 'info');
            
            const angleKeys = designKeys.filter(key => key.includes('_angle_'));
            const otherKeys = designKeys.filter(key => !key.includes('_angle_'));
            
            log(`  ‚úÖ ${angleKeys.length} angle-based design keys`, 'success');
            if (otherKeys.length > 0) {
                log(`  ‚ùå ${otherKeys.length} non-angle design keys`, 'error');
            }
        }

        function cleanupOldDesigns() {
            log('=== Cleaning Up Old Designs ===', 'warning');
            
            // Step 1: Clean the variationDesigns key
            const variationDesignsData = localStorage.getItem('variationDesigns');
            if (variationDesignsData) {
                try {
                    const designs = JSON.parse(variationDesignsData);
                    const cleanedDesigns = designs.filter(design => 
                        design.variationId?.includes('_angle_')
                    );
                    
                    log(`Filtering designs: ${designs.length} ‚Üí ${cleanedDesigns.length}`, 'info');
                    
                    if (cleanedDesigns.length > 0) {
                        localStorage.setItem('variationDesigns', JSON.stringify(cleanedDesigns));
                        log(`‚úÖ Kept ${cleanedDesigns.length} angle-based designs`, 'success');
                    } else {
                        localStorage.removeItem('variationDesigns');
                        log('‚úÖ Removed variationDesigns key (no angle-based designs to keep)', 'success');
                    }
                } catch (e) {
                    log(`Error cleaning variationDesigns: ${e.message}`, 'error');
                }
            }
            
            // Step 2: Clean Redux persist state
            const persistRoot = localStorage.getItem('persist:root');
            if (persistRoot) {
                try {
                    const parsed = JSON.parse(persistRoot);
                    if (parsed.design) {
                        const designState = JSON.parse(parsed.design);
                        const oldCount = designState.variationDesigns?.length || 0;
                        
                        // Filter to keep only angle-based designs
                        designState.variationDesigns = (designState.variationDesigns || []).filter(
                            design => design.variationId?.includes('_angle_')
                        );
                        
                        const newCount = designState.variationDesigns.length;
                        
                        // Clear the problematic productColor
                        if (designState.productColor && designState.productColor.startsWith('var')) {
                            designState.productColor = '';
                            log('‚úÖ Cleared problematic productColor', 'success');
                        }
                        
                        parsed.design = JSON.stringify(designState);
                        localStorage.setItem('persist:root', JSON.stringify(parsed));
                        
                        log(`‚úÖ Cleaned Redux: ${oldCount} ‚Üí ${newCount} designs`, 'success');
                    }
                } catch (e) {
                    log(`Error cleaning Redux state: ${e.message}`, 'error');
                }
            }
            
            // Step 3: Remove non-angle design_ keys
            const designKeys = Object.keys(localStorage).filter(key => key.startsWith('design_'));
            const nonAngleKeys = designKeys.filter(key => !key.includes('_angle_'));
            
            nonAngleKeys.forEach(key => {
                localStorage.removeItem(key);
                log(`  Removed: ${key}`, 'info');
            });
            
            if (nonAngleKeys.length > 0) {
                log(`‚úÖ Removed ${nonAngleKeys.length} non-angle design keys`, 'success');
            }
            
            log('\n‚úÖ Cleanup complete! Refresh the design tool to see the fix.', 'success');
            
            // Re-analyze to show the new state
            setTimeout(() => analyzeCurrentState(), 1000);
        }

        function nukeEverything() {
            if (!confirm('‚ö†Ô∏è This will delete ALL design data. Are you sure?')) return;
            
            log('‚ò¢Ô∏è NUCLEAR OPTION - Clearing all design data...', 'error');
            
            // Remove all design-related keys
            const keysToRemove = Object.keys(localStorage).filter(key => 
                key.includes('design') || 
                key.includes('variation') ||
                key.includes('Design')
            );
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log(`  Removed: ${key}`, 'info');
            });
            
            // Clear Redux design state
            const persistRoot = localStorage.getItem('persist:root');
            if (persistRoot) {
                try {
                    const parsed = JSON.parse(persistRoot);
                    if (parsed.design) {
                        const designState = JSON.parse(parsed.design);
                        designState.variationDesigns = [];
                        designState.currentDesignId = null;
                        designState.productColor = '';
                        parsed.design = JSON.stringify(designState);
                        localStorage.setItem('persist:root', JSON.stringify(parsed));
                        log('  Cleared Redux design state', 'success');
                    }
                } catch (e) {
                    log(`  Error clearing Redux: ${e.message}`, 'error');
                }
            }
            
            log(`\n‚ò¢Ô∏è Removed ${keysToRemove.length} keys total`, 'warning');
            log('All design data has been cleared. Refresh the page to start fresh.', 'success');
            
            updateStats(0, 0, 0);
        }

        // Auto-analyze on load
        window.addEventListener('load', () => {
            analyzeCurrentState();
        });
    </script>
</body>
</html>